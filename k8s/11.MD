# Kubernetes Secrets and Hashicorp Vault

## Task 1: Kubernetes Secrets and Resource Management

### Secret key

```shell
$ kubectl create secret generic sample-secret --from-literal=username='devops' --from-literal=password='devops'
secret/sample-secret created
```

### Get secret key:

```shell
$ kubectl  get secret sample-secret -o json
{
    "apiVersion": "v1",
    "data": {
        "password": "ZGV2b3Bz",
        "username": "ZGV2b3Bz"
    },
    "kind": "Secret",
    "metadata": {
        "creationTimestamp": "2024-04-16T22:34:41Z",
        "name": "sample-secret",
        "namespace": "default",
        "resourceVersion": "521334",
        "uid": "dd93f31b-c300-4bf4-823f-d54ca54d91e5"
    },
    "type": "Opaque"
}
```

###  Decoding the secret key:

```shell
$ echo "ZGV2b3Bz" | base64 --decode
devops
```

### Installing plugin :
`helm plugin install https://github.com/jkroepke/helm-secrets`

### Creating `secrets.yaml` file:

```shell
$ sops -p 36301E6E488CA70790FC3B0B86E97C45A112912A secrets.yaml
```

 ### Installing app-python with secrets:

```shell
$ helm secrets install app-python ./app-python/ -n default -f ./secrets.yaml
[helm-secrets] Decrypt: ./secrets.yaml
NAME: app-python
LAST DEPLOYED: Wed Apr  17 01:50:22 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch the status of by running 'kubectl get --namespace default svc -w app-python'
  export SERVICE_IP=$(kubectl get svc --namespace default app-python --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")
  echo http://$SERVICE_IP:5555

[helm-secrets] Removed: ./secrets.yaml.dec
```

### Retrieving the list of pods: 

```shell
$ kubectl get po
NAME                          READY   STATUS      RESTARTS   AGE
app-python-69fcfbd4fb-l78t2   1/1     Running     0          2m26s
postinstallhook               0/1     Completed   0          2m26s
preinstallhook                0/1     Completed   0          2m34s
```

### Verify  secret inside the pod:

```shell
$ kubectl exec app-python-69fcfbd4fb-l78t2 -- printenv | grep MY_PASS
MY_PASSWORD=devops
```

## Task 2: Vault Secret Management System

### Installing vault:

```shell
$ helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Wed Apr  17 01:55:23 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

### Getting pods, svc:

```shell
$ kubectl get pods,svc
NAME                                       READY   STATUS      RESTARTS   AGE
pod/app-python-69fcfbd4fb-l78t2            1/1     Running     0          6m31s
pod/postinstallhook                        0/1     Completed   0          6m31s
pod/preinstallhook                         0/1     Completed   0          6m39s
pod/vault-0                                1/1     Running     0          96s
pod/vault-agent-injector-dbfc5cd77-x58v7   1/1     Running     0          98s

NAME                               TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/app-python                 LoadBalancer   10.104.14.71     <pending>     5555:30342/TCP      6m31s
service/kubernetes                 ClusterIP      10.96.0.1        <none>        443/TCP             7m40s
service/vault                      ClusterIP      10.107.187.218   <none>        8200/TCP,8201/TCP   98s
service/vault-agent-injector-svc   ClusterIP      10.102.220.11    <none>        443/TCP             98s
service/vault-internal             ClusterIP      None             <none>        8200/TCP,8201/TCP   98s
```